<!DOCTYPE html>
<html>
    <head>
        <title>dna dj</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.3/Tone.js"></script>
        <script src="play_music.js"></script>
        <script src="file_comprehension.js"></script>
        <link rel="stylesheet"  href="stylesheet.css"></style>
    </head>
    <body>
        <div id="container">
            <div id="tophalf">
                <div id="sliderbox">
                    <div class="slider">
                        <div class="mark" id="cave" style="top: 20px;"></div>
                    </div>
                    <div class="slider">
                        <div class="mark" id="desert" style="top: 90px;"></div>
                    </div>
                    <div class="slider">
                        <div class="mark" id="forest" style="top: 50px;"></div>
                    </div>
                    <div class="slider">
                        <div class="mark" id="sea" style="top: 120px;"></div>
                    </div>
                    <label>🪨</label>
                    <label>🏜️</label>
                    <label>🌲</label>
                    <label>🌊</label>
                </div>
                <div id="boopbox">
                    <label>select organism</label>
                    <button id="select" class="boop"></button>
                    <label>upload organism</label>
                    <input type="file" id="upload">
                    <button id="uploadButton" class="boop"></button>
                    <label>play</label>
                    <button id="play" class="boop" onclick="startAudio()"></button>
                </div>
            </div>
            <button class="normal-button">about</button>
            <button class="normal-button">how to use</button>
            <button class="normal-button">other function</button>
        </div>
        <script>
            const fileInput = document.getElementById('upload');
            const uploadButton = document.getElementById('uploadButton');

            // when click upload button, it's as if you click the file input
            uploadButton.addEventListener('click', () => {
                fileInput.click();
            }); 

            // once file selected, process it
            fileInput.addEventListener('change', () => {
                processFile();
            }); 

            // slider stuff
            document.querySelectorAll('.mark').forEach((mark, index) => {
                let isDragging = false;
                let slider = mark.parentElement;

                // get height of slider and mark
                let sliderHeight = slider.offsetHeight;
                let markHeight = mark.offsetHeight;
                
                // when mouse begins click on a slider, set isDragging to true
                mark.addEventListener('mousedown', (e) => {
                    isDragging = true; 
                });

                // when mouse ends click (anywhere!), set isDragging to false
                document.addEventListener('mouseup', (e) => {
                    if (isDragging){
                        isDragging = false; 
                    }
                }); 

                // makes the mark move and changes the slider value
                document.addEventListener('mousemove', (e) => {
                    // if mouse moves while clicking on slider
                    if (isDragging) {
                        // gets rectangle with size and position of .slider relative to viewport
                        let rect = slider.getBoundingClientRect(); 

                        // calculate how far up or down we would want to move the mark absent of restrictions
                        let offsetY = e.clientY - rect.top; // mouse.y - slidertop.y

                        // make sure mark doesn't go below slider (min) or above slider (max)
                        offsetY = Math.max(0, Math.min(sliderHeight - markHeight, offsetY));
                        
                        // move mark
                        mark.style.top = `${offsetY}px`;

                        // change sliderVal to somewhere between 0 and 1
                        let sliderVal = offsetY / (sliderHeight - markHeight);

                        // make that sliderVal change the biome value
                        let biome = biomeList[index];
                        const biomes = {
                            'cave': cave, 'desert': desert,
                            'forest': forest, 'sea': sea
                        };
                        const synths = ["sbd1", "sbd2", "prech", "ch1", "postch1", "postch2", "ch2"];
                        for (const synth of synths) {
                            biomes[biome][synth].volume.value += sliderVal;
                        }
                        biomes[biome].sfx.volume.value += sliderVal;
                        biomes[biome].bg.volume.value += sliderVal;
                        biomes[biome].ramp.volume.value += sliderVal;

                        console.log(`${biome.name} level set to: ${biome.level}`); 

                        updateBackground(); 
                    }
                });      
            }); 

            function updateBackground(){
                const sliderVals = Array.from(document.querySelectorAll('.mark')).map(mark => {
                    let slider = mark.parentElement;
                    let sliderHeight = slider.offsetHeight;
                    let markHeight = mark.offsetHeight;
                    let offsetY = parseFloat(mark.style.top || '0px');
                    return offsetY / (sliderHeight - markHeight);
                });

                const bgImages = [
                    'bgs/cave.jpg',
                    'bgs/desert.jpg',
                    'bgs/forest.jpg',
                    'bgs/sea.jpg'
                ];

                // make sliderVals sum to 1
                const total = sliderVals.reduce((sum, val) => sum + val, 0) || 1; // don't divide by 0
                const opacities = sliderVals.map(val => val / total);

                // apply blended bg img
                const backgroundLayers = bgImages.map((img, index) => `${img} rgba(0,0,0,${opacities[index]}) 50% / cover`).join(', ');
                document.body.style.background = `linear-gradient(to bottom, transparent, transparent), ${backgroundLayers}`; 
            }

        </script>
    </body>
</html>