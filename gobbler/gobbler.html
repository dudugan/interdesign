<!DOCTYPE html>
<html>
    <head>
        <title>Gobbler: a Pathfinding Game</title>
    </head>
    <style>
        :root {
            --gamewindow: 400px; /* default size */
            --numcols: 10; /* default num_cols */
            --cell-size: calc(var(--gamewindow) / var(--numcols)); 
        }
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: white;
            font-family:Georgia, 'Times New Roman', Times, serif
        }
        #game {
            position: relative;
            width: var(--gamewindow);
            height: var(--gamewindow);
            background-color: #ddd;
            display: grid;
            grid-template-columns: repeat(var(--numcols), 1fr);
            grid-template-rows: repeat(var(--numcols), 1fr);
            gap: 5px; 
            border: 2px solid #333;
            border-radius: 10px;
            margin-left: 20px;
            margin-top: 60px; 
            margin-bottom: 60px;
        }
        #monster {
            width: var(--cell-size);
            height: var(--cell-size);
            grid-column: 2;
            grid-row: 2;
            background-size: cover;
        }
        .trash {
            width: var(--cell-size);
            height: var(--cell-size);
            background-image: url('trash.png');
            background-size: cover;
        }
        #scoreboard {
            position: fixed;
            z-index: 1;
            top: 10px;
            left: 20px;
            font-size: 15px;
        }
    </style>
    <body>
        <div id="scoreboard">
            current score: <span id="score-display">0</span> ||
            high score: <span id="highscore-display">0</span>
        </div>
        <div id="game">
            <img id="monster" src="monster.png">
        </div>
        <div id="scoresaver">
            <form class="gform pure-form pure-form-stacked" method="POST">
                <div class="form-elements">
                    <fieldset>
                        <label for="name">Name: </label>
                        <input id="name" name="name" placeholder="What your Mom calls you">
                    </fieldset>
                    <fieldset>
                        <label for="score">High Score: </label>
                        <input id="highscore" name="highscore" type="number" placeholder="You have to play first!" readonly>
                    </fieldset>
                    <button type="button" class="button-success pure-button button-xlarge" onclick="submitGameScore()">
                        Submit Score
                    </button>
                </div>
            </form>
        </div>
        <script data-cfasync="false" src="submit-data.js"></script>
    </body>
    <script>
        const monster = document.getElementById('monster');
        const game = document.getElementById('game'); 
        const gridSize = 10;
        let currentScore = 0; 
        let highScore = localStorage.getItem("highScore") ? parseInt(localStorage.getItem("highScore")) : 0; 
        document.getElementById("highscore-display").textContent = highScore;
        document.getElementById("highscore").value = highScore;
        let monsterX = 1;
        let monsterY = 1;
        let trashBags = []; 

        // update high score
        function updateScore(newScore){
            if (newScore > highScore){
                highScore = newScore;
                localStorage.setItem("highScore", highScore); 
                document.getElementById("highscore-display").textContent = highScore;
                document.getElementById("highscore").value = highScore; 
            }
        }

        // submit score
        function submitGameScore(){
            const tagName = document.getElementById("name").value;
            submitScore(tagName, highScore); 
        }

        // remove existing trash and add new trash
        function trashify(){
            // remove existing trash bags
            trashBags.forEach(trash => trash.remove());
            trashBags = [];

            // add new trash bags, not over each other
            // create a set, the first item being the monster's position
            const occupiedPositions = new Set([`${monsterX}-${monsterY}`]);
            // add the new trash positions to the set
            for (let i = 0; i < 3; i++){
                let x, y;
                do {
                    x = Math.floor(Math.random() * gridSize) + 1;
                    y = Math.floor(Math.random() * gridSize) + 1;
                } while (occupiedPositions.has(`${x}-${y}`));
                occupiedPositions.add(`${x}-${y}`);

                const trash = document.createElement('div');
                trash.className = 'trash';
                trash.style.gridColumn = x;
                trash.style.gridRow = y;
                game.appendChild(trash);
                trashBags.push(trash); 
            }
        }

        // check if monster is on a trash bag
        function checkGobble(){
            const monsterPosition = `${monsterX}-${monsterY}`;
            for (const trash of trashBags){
                const trashPosition = `${trash.style.gridColumn}-${trash.style.gridRow}`;
                if (monsterPosition === trashPosition) {
                    // play audio (quietly)
                    var yum = new Audio('yum.mp3');
                    yum.volume = 0.1; 
                    yum.play(); 
                    // new trash
                    trashify();
                    // increment score
                    addScore(); 
                    break;
                }
            }
        }

        // update scoreboard
        function addScore(){
            currentScore++; 
            document.getElementById("score-display").textContent = currentScore;
            updateScore(currentScore); 
        }

        // move with WASD or arrow keys
        document.addEventListener('keydown', (event) => {
            switch (event.key){
                case 'ArrowUp':
                case 'w': // up
                    if (monsterY > 1) monsterY--; 
                    break; 
                case 'ArrowLeft':
                case 'a': // left
                    if (monsterX > 1) monsterX--; 
                    break; 
                case 'ArrowDown':
                case 's': // down
                    if (monsterY < gridSize) monsterY++;
                    break; 
                case 'ArrowRight':
                case 'd': // right
                    if (monsterX < gridSize) monsterX++;
                    break; 
                default:
                    return; 
            }
            // update position
            monster.style.gridColumn = monsterX;
            monster.style.gridRow = monsterY; 

            // check for trash
            checkGobble(); 
        });

        // update game window size
        function updateSize(){
            const minDim = Math.min(window.innerWidth, window.innerHeight) - 40;
            document.documentElement.style.setProperty('--gamewindow', `${minDim}px`);
            document.documentElement.style.setProperty('--cell-size', `${minDim / gridSize}px`); 
        }

        updateSize();

        // update size on resize
        window.addEventListener('resize', updateSize);

        // generate initial trash
        trashify(); 
    </script>
</html>