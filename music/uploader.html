<!DOCTYPE html>
<html>
<head>
    <title>Uploader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.1.3/Tone.js"></script>
</head>
<style>
    body {height: 100vh; width: 100vw; text-align: center;}
    #outputText {
        margin-top: 20px;
        font-size: 25px;
        line-height: 1.6;
        color: blueviolet; 
    }
</style>
<body>
    <h1>Upload a dna file pls</h1>
    <input type="file" id="fileInput">
    <button onclick="processFile()">Upload</button>
</body>
<script>
    let poly, snare, kick; 
    let char_index = 0;
    let fileContent = ""; 
    let baseURL = "https://s3-us-west-1.amazonaws.com/leesamples/samples/"; 

    function initializeAudio(){
        console.log("Initializing Audio");
        poly = new Tone.PolySynth(Tone.AMSynth, 
            {
                // set ADSR
                envelope: {
                    attack: '2n', 
                    release: '2n'
                }
            }
        ); 
        poly.toDestination(); 
        console.log("set polysynth");

        Tone.Transport.bpm.value = 120;
        Tone.Transport.timeSignature = 4; // Default is 4/4
        console.log("set bpm and time signature");

         // loop per measure
        const loop = new Tone.Loop(time => {
            const char = fileContent[char_index];
            if (char) { // Check if character exists
                console.log("Playing note ", char);
                play(char);
                char_index++;
            } else {
                // Stop loop if no more characters
                Tone.Transport.stop();
                Tone.Transport.cancel();
                console.log("End of file content.");
            } 
        }, "1m").start(0); 
        console.log("made char loop");


        snare = new Tone.Player("https://dudugan.github.io/interdesign/music/assets/snare.mp3").toDestination();
        kick = new Tone.Player("https://dudugan.github.io/interdesign/music/assets/kick.mp3").toDestination();

        Promise.all([snare.load(), kick.load()]).then(() => {
            // Start loops for snare and kick once theyâ€™re loaded
            const snareLoop = new Tone.Loop(time => {
                snare.start(time);
            }, "2n").start("4n"); // Play every two beats, delayed by a quarter note

            const kickLoop = new Tone.Loop(time => {
                kick.start(time);
            }, "2n").start("3n"); // Play every two beats, delayed by a quarter note

            // Start the transport after snare and kick are loaded
            Tone.Transport.start();
        });
        // Tone.Transport.start();
    }

    function play(nucleotide){
        switch (nucleotide){
            case 'A':
                chord_array = ["A2", "C2", "E2", "G2"]; 
                break;
            case 'C':
                chord_array = ["C2", "E2", "G2", "B3"]; 
                break;
            case 'G':
                chord_array = ["G2", "B3", "D3", "F3"]; 
                break;
            case 'T': // interpret 'T' as 'E'
                chord_array = ["E2", "G2", "B3", "D3"]; 
                break; 
        }
        if (chord_array) {
            poly.triggerAttackRelease(chord_array, '1m');
        }    
    }

    async function processFile(){        
        const fileInput = document.getElementById('fileInput');

        if (fileInput.files.length === 0){
            alert('Please select a file');
            return; 
        }
        
        const file = fileInput.files[0]
        const reader = new FileReader();

        reader.onload = async function(event){
            fileContent = event.target.result;
            initializeAudio(); 
        }

        reader.readAsText(file); 
    }
</script>
</html>